#!/bin/sh

# Pre-push hook to validate build configuration
# This ensures Prisma is correctly configured and code passes linting before pushing

if [ -d tmp ]; then
  rm -rf tmp
fi
mkdir tmp

npm test --silent > tmp/test.log 2> tmp/test.error.log
if [ $? -ne 0 ]; then
  cat tmp/test.error.log
  echo "❌ Tests failed!"
  echo "Please fix failing tests before pushing."
  exit 1
fi

npm run --silent lint -- --quiet > tmp/lint.log 2> tmp/lint.error.log
if [ $? -ne 0 ]; then
  npm run --silent lint -- --quiet --fix
  echo "❌ Linting failed!"
  echo "Please fix linting errors before pushing."
  exit 1
fi

npm run --silent build > tmp/build.log 2> tmp/build.error.log
if [ $? -ne 0 ]; then
  cat tmp/build.error.log
  echo "❌ Build failed!"
  echo "Please fix the errors above before pushing."
  exit 1
fi

npm run --silent validate:build > tmp/validate_build.log 2> tmp/validate_build.error.log
if [ $? -ne 0 ]; then
  cat tmp/validate_build.error.log
  echo "❌ Build validation failed!"
  echo "Please fix the errors above before pushing."
  exit 1
fi

exit 0
